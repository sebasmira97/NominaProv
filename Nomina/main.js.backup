let employeeCount = 0;

// Funci√≥n para cargar ciudades desde la API
async function loadCitiesFromAPI(apiUrl) {
    try {
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseData = await response.json();
        
        // Extraer ciudades de la estructura espec√≠fica: dataRecords.data
        const cities = responseData.dataRecords?.data || [];
        
        // Mapear a formato est√°ndar con informaci√≥n completa
        return cities.map(city => ({
            id: city.id,
            name: city.name_city
        }));
        
    } catch (error) {
        console.error('Error cargando ciudades desde la API:', error);
        alert('‚ùå Error al cargar las ciudades desde la API. Verifique la conexi√≥n.');
        return [];
    }
}

// Funci√≥n para poblar el select de ciudades
function populateCitySelect(cities, selectElement) {
    // Limpiar opciones existentes
    selectElement.innerHTML = '<option value="">Seleccione una ciudad...</option>';
    
    cities.forEach(city => {
        const option = document.createElement('option');
        // Usar el ID como valor
        option.value = city.id;
        option.textContent = city.name;
        selectElement.appendChild(option);
    });
}

// Funci√≥n para convertir input de ciudad a select con datos de la API
async function convertCityInputToSelect(apiUrl) {
    const cityInput = document.getElementById('generationCityId');
    if (!cityInput) return;
    
    // Crear nuevo select
    const citySelect = document.createElement('select');
    citySelect.id = 'generationCityId';
    citySelect.className = cityInput.className;
    citySelect.style.cssText = cityInput.style.cssText;
    
    // Mantener el valor actual como opci√≥n por defecto
    const currentValue = cityInput.value;
    
    // Cargar ciudades desde la API
    const cities = await loadCitiesFromAPI(apiUrl);
    
    if (cities.length > 0) {
        populateCitySelect(cities, citySelect);
        
        // Si hab√≠a un valor previo, intentar seleccionarlo
        if (currentValue) {
            const matchingOption = Array.from(citySelect.options).find(
                option => option.value === currentValue
            );
            if (matchingOption) {
                citySelect.value = currentValue;
            }
        }
        
        // Reemplazar input por select
        cityInput.parentNode.replaceChild(citySelect, cityInput);
        
        console.log('‚úÖ Campo de ciudad convertido a select con datos de la API');
    } else {
        console.warn('‚ö†Ô∏è No se pudieron cargar ciudades de la API, manteniendo input original');
    }
}

// Funci√≥n gen√©rica para cargar ciudades en cualquier select
async function setupCitySelect(selectElement, apiUrl, defaultValue = null) {
    const cities = await loadCitiesFromAPI(apiUrl);
    
    if (cities.length > 0) {
        populateCitySelect(cities, selectElement);
        
        if (defaultValue) {
            selectElement.value = defaultValue;
        }
    }
}

// Funci√≥n para probar la conexi√≥n con la API
async function testAPIConnection() {
    const API_URL = 'https://api-v2.matias-api.com/api/ubl2.1/cities';
    
    try {
        console.log('üîç Probando conexi√≥n con la API...');
        const cities = await loadCitiesFromAPI(API_URL);
        
        if (cities.length > 0) {
            console.log('‚úÖ API conectada exitosamente!');
            console.log(`üìä Se encontraron ${cities.length} ciudades`);
            console.log('üèôÔ∏è Ejemplos de ciudades:', cities.slice(0, 3));
            return true;
        } else {
            console.warn('‚ö†Ô∏è API conectada pero no devolvi√≥ ciudades');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error conectando con la API:', error);
        return false;
    }
}

// Funci√≥n para llamar desde la consola del navegador para debug
window.testAPI = testAPIConnection;
window.reloadCities = reloadCities;

// ========================================
// FUNCIONES DE GENERACI√ìN DE JSON
// ========================================

function generateEmployeeJSON(employeeDiv) {
    const getVal = (selector, defaultVal = '') => {
        const element = employeeDiv.querySelector(selector);
        return element ? element.value.trim() : defaultVal;
    };
    
    const getNumVal = (selector, defaultVal = 0) => {
        const val = parseFloat(getVal(selector));
        return isNaN(val) ? defaultVal : val;
    };

    const getCurrentTime = () => {
        const now = new Date();
        return now.toTimeString().split(' ')[0];
    };

    const timeNow = getCurrentTime();
    
    const salary = getNumVal('.salary');
    const workedDays = getNumVal('.workedDays', 30);
    
    // Horas extras - OBTENER VALORES REALES DEL FORMULARIO
    const hedAmount = getNumVal('.hedAmount');
    const hedPercentage = getNumVal('.hedPercentage', 25);
    const hedPayment = getNumVal('.hedPayment');
    
    const henAmount = getNumVal('.henAmount');
    const henPercentage = getNumVal('.henPercentage', 75);
    const henPayment = getNumVal('.henPayment');
    
    const hedfAmount = getNumVal('.hedfAmount');
    const hedfPercentage = getNumVal('.hedfPercentage', 100);
    const hedfPayment = getNumVal('.hedfPayment');
    
    const hrnAmount = getNumVal('.hrnAmount');
    const hrnPercentage = getNumVal('.hrnPercentage', 35);
    const hrnPayment = getNumVal('.hrnPayment');
    
    const hrdfAmount = getNumVal('.hrdfAmount');
    const hrdfPercentage = getNumVal('.hrdfPercentage', 75);
    const hrdfPayment = getNumVal('.hrdfPayment');
    
    const hendfAmount = getNumVal('.hendfAmount');
    const hendfPercentage = getNumVal('.hendfPercentage', 150);
    const hendfPayment = getNumVal('.hendfPayment');
    
    const hrndfAmount = getNumVal('.hrndfAmount');
    const hrndfPercentage = getNumVal('.hrndfPercentage', 110);
    const hrndfPayment = getNumVal('.hrndfPayment');
    
    // Calcular total horas extras
    const totalOvertimePayment = hedPayment + henPayment + hedfPayment + hrnPayment + hrdfPayment + hendfPayment + hrndfPayment;
    
    // Calcular total devengado
    const salaryWorked = getNumVal('.salaryWorked');
    const otherConcepts = bonusPayment + primePayment + commission + conceptS;
    const totalEarned = salaryWorked + transportationAssistance + totalOvertimePayment + otherConcepts;
    
    // Deducciones
    const healthDeduction = getNumVal('.healthDeduction');
    const pensionDeduction = getNumVal('.pensionDeduction');
    const thirdPartyPay = getNumVal('.thirdPartyPay');
    const otherDeduction = getNumVal('.otherDeduction');
    
    const totalDeductions = healthDeduction + pensionDeduction + thirdPartyPay + otherDeduction;
    const totalVoucher = totalEarned - totalDeductions;

    return {
        "resolution_number": document.getElementById('resolutionNumber').value || "18760000001",
        "document_number": document.getElementById('documentNumber').value || "27",
        "generation_city_id": document.getElementById('generationCityId').value || "1",
        "worker_code": getVal('.workerCode'),
        "novelty": false,
        "pay_day": document.getElementById('payDay').value || new Date().toISOString().split('T')[0],
        "period": {
            "date_entry": document.getElementById('dateEntry').value || "",
            "departure_date": document.getElementById('departureDate').value || null,
            "settlement_start_date": document.getElementById('settlementStartDate').value || new Date().toISOString().split('T')[0],
            "settlement_end_date": document.getElementById('settlementEndDate').value || new Date().toISOString().split('T')[0],
            "time_worked": document.getElementById('timeWorked').value || "30",
            "generation_date": document.getElementById('generationDate').value || new Date().toISOString().split('T')[0]
        },
        "general_information": {
            "generation_date": document.getElementById('generationDate').value || new Date().toISOString().split('T')[0],
            "generation_time": timeNow,
            "period_id": document.getElementById('periodId').value || "5",
            "currency_id": "272",
            "trm": "0"
        },
        "notes": "",
        "employee": {
            "worker_type_id": parseInt(getVal('.workerTypeId', '1')),
            "worker_subtype_id": parseInt(getVal('.workerSubtypeId', '1')),
            "high_risk_pension": getVal('.highRiskPension', 'false'),
            "identity_document_id": getVal('.identityDocumentId', '1'),
            "document_number": getVal('.documentNumber'),
            "first_surname": getVal('.firstSurname'),           // ‚Üê Primer apellido (obligatorio)
            "second_surname": getVal('.secondSurname'),         // ‚Üê Segundo apellido (opcional)
            "first_name": getVal('.firstName'),                 // ‚Üê Primer nombre (obligatorio)
            "other_names": getVal('.otherNames'),               // ‚Üê Segundo nombre (opcional)
            "working_country_id": getNumVal('.workingCountryId', 45),
            "work_city_id": getNumVal('.workCityId'),
            "work_address": getVal('.workAddress'),
            "integral_salary": getVal('.integralSalary', 'false'),
            "contract_type_id": parseInt(getVal('.contractTypeId', '1')),
            "salary": salary.toString(),
            "worker_code": getVal('.workerCode')
        },
        "payment": {
            "payment_method_id": getVal('.paymentMethodId', '1'),
            "means_payment_id": getVal('.meansPaymentId', '31'),
            "bank": getVal('.bank'),
            "account_type": getVal('.accountType'),
            "account_number": getVal('.accountNumber')
        },
        "earn": {
            "basic": {
                "worked_days": workedDays.toString(),
                "salary_worked": getNumVal('.salaryWorked', salary).toString()
            },
            "transport": {
                "transportation_assistance": transportationAssistance.toString(),
                "viatic_maintenance": getNumVal('.viaticMaintenance').toString(),
                "viatic_non_salary_maintenance": getNumVal('.viaticNonSalary').toString()
            },
            "HEDs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedAmount.toString(),
                    "percentage": hedPercentage.toFixed(2),
                    "payment": hedPayment.toFixed(2)
                }
            ],
            "HENs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": henAmount.toString(),
                    "percentage": henPercentage.toFixed(2),
                    "payment": henPayment.toFixed(2)
                }
            ],
            "HRNs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrnAmount.toString(),
                    "percentage": hrnPercentage.toFixed(2),
                    "payment": hrnPayment.toFixed(2)
                }
            ],
            "HEDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedfAmount.toString(),
                    "percentage": hedfPercentage.toFixed(2),
                    "payment": hedfPayment.toFixed(2)
                }
            ],
            "HRDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrdfAmount.toString(),
                    "percentage": hrdfPercentage.toFixed(2),
                    "payment": hrdfPayment.toFixed(2)
                }
            ],
            "HENDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hendfAmount.toString(),
                    "percentage": hendfPercentage.toFixed(2),
                    "payment": hendfPayment.toFixed(2)
                }
            ],
            "HRNDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrndfAmount.toString(),
                    "percentage": hrndfPercentage.toFixed(2),
                    "payment": hrndfPayment.toFixed(2)
                }
            ],
            "vacations": {
                "common": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "paid": {
                    "amount": "0",
                    "payment": "0.00"
                }
            },
            "bonus": {
                "amount": "0",
                "payment": bonusPayment.toFixed(2),
                "non_salary_payment": primePayment.toFixed(2)
            },
            "cesantias": {
                "payment": "0",
                "percentage": "0.00",
                "interest_payment": "0.00"
            },
            "incapacity": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "type_id": 1,
                    "payment": "0.00"
                }
            ],
            "licenses": {
                "licenseMP": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseNR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            },
            "bonuses": [
                {
                    "bonusS": bonusPayment.toFixed(2),
                    "bonusNS": primePayment.toFixed(2)
                }
            ],
            "assistances": [
                {
                    "assistanceS": "0.00",
                    "assistanceNS": "0.00"
                }
            ],
            "legal_strikes": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            ],
            "other_concepts": [
                {
                    "description": "Otros conceptos",
                    "conceptS": conceptS.toFixed(2),
                    "conceptNS": "0.00"
                }
            ],
            "compensations": [
                {
                    "compensationO": "0.00",
                    "compensationE": "0.00"
                }
            ],
            "bondEPCTVs": [
                {
                    "paymentS": "0.00",
                    "paymentNS": "0.00",
                    "payment_foodS": "0.00",
                    "payment_foodNS": "0.00"
                }
            ],
            "commissions": [
                {
                    "commission": commission.toFixed(2)
                }
            ],
            "payments_third_party": [
                {
                    "payment_third_party": "0.00"
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "endowment": "0.00",
            "sustaining_support": "0.00",
            "teleworking": "0.00",
            "withdrawal_bonus": "0.00",
            "indemnification": "0.00",
            "refund": "0.00"
        },
        "deductions": {
            "health": {
                "percentage": getNumVal('.healthPercentage', 4).toString(),
                "deduction": healthDeduction.toString()
            },
            "pension_fund": {
                "percentage": getNumVal('.pensionPercentage', 4).toString(),
                "deduction": pensionDeduction.toString()
            },
            "fundSP": {
                "percentage": "0.00",
                "deduction": "0.00",
                "percentageSub": "0.00",
                "deductionSub": "0.00"
            },
            "trade_union": [
                {
                    "percentage": "0.00",
                    "deduction": "0.00"
                }
            ],
            "sanctions": [
                {
                    "sanctionPublic": "0.00",
                    "sanctionPriv": "0.00"
                }
            ],
            "libranzas": [
                {
                    "description": "",
                    "deduction": "0.00"
                }
            ],
            "third_party_payment": [
                {
                    "third_party_pay": thirdPartyPay.toFixed(2)
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "other_deductions": [
                {
                    "other_deduction": otherDeduction.toFixed(2)
                }
            ],
            "voluntary_pension": "0.00",
            "retefuente": "0.00",
            "afc": "0.00",
            "cooperative": "0.00",
            "tax_embargo": "0.00",
            "complementary_plan": "0.00",
            "education": "0.00",
            "refund": "0.00",
            "debt": "0.00"
        },
        "rounding": Math.round(totalVoucher % 100).toString(),
        "total_earned": totalEarned.toString(),
        "deductions_total": totalDeductions.toString(),
        "total_voucher": totalVoucher.toString()
    };
}

function updatePreview() {
    const employees = document.querySelectorAll('.employee-section');
    if (employees.length === 0) {
        document.getElementById('jsonPreview').textContent = 'Agregue al menos un empleado para ver la vista previa...';
        return;
    }
    
    const allEmployeesJSON = [];
    employees.forEach(emp => {
        allEmployeesJSON.push(generateEmployeeJSON(emp));
    });
    
    const preview = allEmployeesJSON.length === 1 ? 
        allEmployeesJSON[0] : 
        { "employees": allEmployeesJSON };
        
    document.getElementById('jsonPreview').textContent = JSON.stringify(preview, null, 2);
}

function generateJSON() {
    const validation = validateRequiredFields();
    
    if (!validation.isValid) {
        alert(`Por favor complete los siguientes campos obligatorios:\n‚Ä¢ ${validation.errors.join('\n‚Ä¢ ')}`);
        return;
    }

    const employees = document.querySelectorAll('.employee-section');
    if (employees.length === 0) {
        alert('‚ùå Por favor agregue al empleado antes de generar el JSON');
        return;
    }
    
    const allEmployeesJSON = [];
    employees.forEach(emp => {
        allEmployeesJSON.push(generateEmployeeJSON(emp));
    });
    
    let finalJSON;
    let filename;
    
    if (allEmployeesJSON.length === 1) {
        finalJSON = allEmployeesJSON[0];
        const employeeName = finalJSON.employee.first_name + '_' + finalJSON.employee.first_surname;
        filename = `nomina_${employeeName}_${finalJSON.period.settlement_end_date}.json`;
    } else {
        finalJSON = { "employees": allEmployeesJSON };
        filename = `nomina_multiple_${new Date().toISOString().split('T')[0]}.json`;
    }
    
    // Crear y descargar archivo
    const blob = new Blob([JSON.stringify(finalJSON, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    // Tambi√©n generar archivo TXT
    const txtBlob = new Blob([JSON.stringify(finalJSON, null, 2)], { type: 'text/plain' });
    const txtUrl = URL.createObjectURL(txtBlob);
    const txtA = document.createElement('a');
    txtA.href = txtUrl;
    txtA.download = filename.replace('.json', '.txt');
    txtA.click();
    URL.revokeObjectURL(txtUrl);
    
    alert(`‚úÖ Archivos generados exitosamente:\n\nüìÑ ${filename}\nüìÑ ${filename.replace('.json', '.txt')}\n\nLos archivos est√°n listos para transmisi√≥n de n√≥mina electr√≥nica.`);
}

// Funci√≥n para actualizar el resumen de pagos
function updatePaymentSummary() {
    const employeeDiv = document.querySelector('.employee-section');
    if (!employeeDiv) return;

    const getNumVal = (selector) => {
        const element = employeeDiv.querySelector(selector);
        return parseFloat(element?.value) || 0;
    };

    // Devengados
    const salaryWorked = getNumVal('.salaryWorked');
    
    // Todas las horas extras
    const hedPayment = getNumVal('.hedPayment');
    const henPayment = getNumVal('.henPayment');
    const hedfPayment = getNumVal('.hedfPayment');
    const hrnPayment = getNumVal('.hrnPayment');
    const hrdfPayment = getNumVal('.hrdfPayment');
    const hendfPayment = getNumVal('.hendfPayment');
    const hrndfPayment = getNumVal('.hrndfPayment');
    
    const totalOvertime = hedPayment + henPayment + hedfPayment + hrnPayment + hrdfPayment + hendfPayment + hrndfPayment;
    
    const transportationAssistance = getNumVal('.transportationAssistance');
    const bonusPayment = getNumVal('.bonusPayment');
    const primePayment = getNumVal('.primePayment');
    const commission = getNumVal('.commission');
    const conceptS = getNumVal('.conceptS');
    const otherConcepts = bonusPayment + primePayment + commission + conceptS;
    const totalEarned = salaryWorked + totalOvertime + transportationAssistance + otherConcepts;

    // Deducciones
    const healthDeduction = getNumVal('.healthDeduction');
    const pensionDeduction = getNumVal('.pensionDeduction');
    const thirdPartyPay = getNumVal('.thirdPartyPay');
    const otherDeduction = getNumVal('.otherDeduction');
    const otherDeductions = thirdPartyPay + otherDeduction;
    const totalDeductions = healthDeduction + pensionDeduction + otherDeductions;

    // Neto a pagar
    const netPay = totalEarned - totalDeductions;

    // Actualizar resumen
    const formatCurrency = (value) => new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
    }).format(value);

    // Actualizar elementos si existen
    const summaryElements = {
        '.summary-salaryWorked': salaryWorked,
        '.summary-overtime': totalOvertime,
        '.summary-transport': transportationAssistance,
        '.summary-others': otherConcepts,
        '.summary-totalEarned': totalEarned,
        '.summary-health': healthDeduction,
        '.summary-pension': pensionDeduction,
        '.summary-otherDeductions': otherDeductions,
        '.summary-totalDeductions': totalDeductions,
        '.summary-netPay': netPay
    };

    Object.entries(summaryElements).forEach(([selector, value]) => {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = formatCurrency(value);
        }
    });
}

// Funci√≥n para validar campos obligatorios
function validateRequiredFields() {
    const meansPaymentSelect = document.querySelector('.meansPaymentId');
    const isEffectivo = meansPaymentSelect?.value === '10';
    
    let requiredSelectors = [
        '.documentNumber',
        '.firstName', 
        '.firstSurname',
        '.salary',
        '.workerCode',
        '.workAddress'
    ];
    
    if (!isEffectivo) {
        requiredSelectors.push('.bank', '.accountNumber');
    }

    let isValid = true;
    const errors = [];

    requiredSelectors.forEach(selector => {
        const field = document.querySelector(selector);
        const formGroup = field?.closest('.form-group');
        
        if (field && formGroup) {
            formGroup.classList.remove('has-error');
            const existingError = formGroup.querySelector('.error-message');
            if (existingError) existingError.remove();

            if (!field.readOnly && !field.value.trim()) {
                isValid = false;
                const fieldName = field.closest('.form-group').querySelector('label').textContent.replace('*', '').trim();
                errors.push(fieldName);
                
                formGroup.classList.add('has-error');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'Este campo es obligatorio';
                field.parentNode.appendChild(errorMsg);
            }
        }
    });

    return { isValid, errors };
}

// Funci√≥n principal para generar el JSON del empleado
function generateEmployeeJSON() {
    const employeeDiv = document.querySelector('.employee-section');
    if (!employeeDiv) return null;

    const getVal = (selector, defaultVal = '') => {
        const element = employeeDiv.querySelector(selector);
        return element ? element.value.trim() : defaultVal;
    };
    
    const getNumVal = (selector, defaultVal = 0) => {
        const val = parseFloat(getVal(selector));
        return isNaN(val) ? defaultVal : val;
    };

    const getCurrentTime = () => {
        const now = new Date();
        return now.toTimeString().split(' ')[0];
    };

    const timeNow = getCurrentTime();
    
    // Datos b√°sicos
    const salary = getNumVal('.salary');
    const workedDays = getNumVal('.workedDays', 30);
    
    // Todas las horas extras
    const hedAmount = getNumVal('.hedAmount');
    const hedPercentage = getNumVal('.hedPercentage', 25);
    const hedPayment = getNumVal('.hedPayment');
    
    const henAmount = getNumVal('.henAmount');
    const henPercentage = getNumVal('.henPercentage', 75);
    const henPayment = getNumVal('.henPayment');
    
    const hedfAmount = getNumVal('.hedfAmount');
    const hedfPercentage = getNumVal('.hedfPercentage', 100);
    const hedfPayment = getNumVal('.hedfPayment');
    
    const hrnAmount = getNumVal('.hrnAmount');
    const hrnPercentage = getNumVal('.hrnPercentage', 35);
    const hrnPayment = getNumVal('.hrnPayment');
    
    const hrdfAmount = getNumVal('.hrdfAmount');
    const hrdfPercentage = getNumVal('.hrdfPercentage', 75);
    const hrdfPayment = getNumVal('.hrdfPayment');
    
    const hendfAmount = getNumVal('.hendfAmount');
    const hendfPercentage = getNumVal('.hendfPercentage', 150);
    const hendfPayment = getNumVal('.hendfPayment');
    
    const hrndfAmount = getNumVal('.hrndfAmount');
    const hrndfPercentage = getNumVal('.hrndfPercentage', 110);
    const hrndfPayment = getNumVal('.hrndfPayment');
    
    // Otros conceptos
    const transportationAssistance = getNumVal('.transportationAssistance');
    const bonusPayment = getNumVal('.bonusPayment');
    const primePayment = getNumVal('.primePayment');
    const commission = getNumVal('.commission');
    const conceptS = getNumVal('.conceptS');
    
    // Calcular totales
    const totalOvertimePayment = hedPayment + henPayment + hedfPayment + hrnPayment + hrdfPayment + hendfPayment + hrndfPayment;
    const salaryWorked = getNumVal('.salaryWorked');
    const totalEarned = salaryWorked + transportationAssistance + totalOvertimePayment + bonusPayment + primePayment + commission + conceptS;
    
    // Deducciones
    const healthDeduction = getNumVal('.healthDeduction');
    const pensionDeduction = getNumVal('.pensionDeduction');
    const thirdPartyPay = getNumVal('.thirdPartyPay');
    const otherDeduction = getNumVal('.otherDeduction');
    
    const totalDeductions = healthDeduction + pensionDeduction + thirdPartyPay + otherDeduction;
    const totalVoucher = totalEarned - totalDeductions;

    return {
        "resolution_number": document.getElementById('resolutionNumber')?.value || "18760000001",
        "document_number": document.getElementById('documentNumber')?.value || "27",
        "generation_city_id": document.getElementById('generationCityId')?.value || "1",
        "worker_code": getVal('.workerCode'),
        "novelty": false,
        "pay_day": document.getElementById('payDay')?.value || new Date().toISOString().split('T')[0],
        "period": {
            "date_entry": document.getElementById('dateEntry')?.value || "",
            "departure_date": document.getElementById('departureDate')?.value || null,
            "settlement_start_date": document.getElementById('settlementStartDate')?.value || new Date().toISOString().split('T')[0],
            "settlement_end_date": document.getElementById('settlementEndDate')?.value || new Date().toISOString().split('T')[0],
            "time_worked": document.getElementById('timeWorked')?.value || "30",
            "generation_date": document.getElementById('generationDate')?.value || new Date().toISOString().split('T')[0]
        },
        "general_information": {
            "generation_date": document.getElementById('generationDate')?.value || new Date().toISOString().split('T')[0],
            "generation_time": timeNow,
            "period_id": document.getElementById('periodId')?.value || "5",
            "currency_id": "272",
            "trm": "0"
        },
        "notes": "",
        "employee": {
            "worker_type_id": parseInt(getVal('.workerTypeId', '1')),
            "worker_subtype_id": parseInt(getVal('.workerSubtypeId', '1')),
            "high_risk_pension": getVal('.highRiskPension', 'false'),
            "identity_document_id": getVal('.identityDocumentId', '1'),
            "document_number": getVal('.documentNumber'),
            "first_surname": getVal('.firstSurname'),
            "second_surname": getVal('.secondSurname'),
            "first_name": getVal('.firstName'),
            "other_names": getVal('.otherNames'),
            "working_country_id": getNumVal('.workingCountryId', 45),
            "work_city_id": getNumVal('.workCityId'),
            "work_address": getVal('.workAddress'),
            "integral_salary": getVal('.integralSalary', 'false'),
            "contract_type_id": parseInt(getVal('.contractTypeId', '1')),
            "salary": salary.toString(),
            "worker_code": getVal('.workerCode')
        },
        "payment": {
            "payment_method_id": getVal('.paymentMethodId', '1'),
            "means_payment_id": getVal('.meansPaymentId', '31'),
            "bank": getVal('.bank'),
            "account_type": getVal('.accountType'),
            "account_number": getVal('.accountNumber')
        },
        "earn": {
            "basic": {
                "worked_days": workedDays.toString(),
                "salary_worked": salaryWorked.toString()
            },
            "transport": {
                "transportation_assistance": transportationAssistance.toString(),
                "viatic_maintenance": getNumVal('.viaticMaintenance').toString(),
                "viatic_non_salary_maintenance": getNumVal('.viaticNonSalary').toString()
            },
            "HEDs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedAmount.toString(),
                    "percentage": hedPercentage.toFixed(2),
                    "payment": hedPayment.toFixed(2)
                }
            ],
            "HENs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": henAmount.toString(),
                    "percentage": henPercentage.toFixed(2),
                    "payment": henPayment.toFixed(2)
                }
            ],
            "HRNs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrnAmount.toString(),
                    "percentage": hrnPercentage.toFixed(2),
                    "payment": hrnPayment.toFixed(2)
                }
            ],
            "HEDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedfAmount.toString(),
                    "percentage": hedfPercentage.toFixed(2),
                    "payment": hedfPayment.toFixed(2)
                }
            ],
            "HRDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrdfAmount.toString(),
                    "percentage": hrdfPercentage.toFixed(2),
                    "payment": hrdfPayment.toFixed(2)
                }
            ],
            "HENDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hendfAmount.toString(),
                    "percentage": hendfPercentage.toFixed(2),
                    "payment": hendfPayment.toFixed(2)
                }
            ],
            "HRNDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrndfAmount.toString(),
                    "percentage": hrndfPercentage.toFixed(2),
                    "payment": hrndfPayment.toFixed(2)
                }
            ],
            "vacations": {
                "common": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "paid": {
                    "amount": "0",
                    "payment": "0.00"
                }
            },
            "bonus": {
                "amount": "0",
                "payment": bonusPayment.toFixed(2),
                "non_salary_payment": primePayment.toFixed(2)
            },
            "cesantias": {
                "payment": "0",
                "percentage": "0.00",
                "interest_payment": "0.00"
            },
            "incapacity": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "type_id": 1,
                    "payment": "0.00"
                }
            ],
            "licenses": {
                "licenseMP": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseNR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            },
            "bonuses": [
                {
                    "bonusS": bonusPayment.toFixed(2),
                    "bonusNS": primePayment.toFixed(2)
                }
            ],
            "assistances": [
                {
                    "assistanceS": "0.00",
                    "assistanceNS": "0.00"
                }
            ],
            "legal_strikes": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            ],
            "other_concepts": [
                {
                    "description": "Otros conceptos",
                    "conceptS": conceptS.toFixed(2),
                    "conceptNS": "0.00"
                }
            ],
            "compensations": [
                {
                    "compensationO": "0.00",
                    "compensationE": "0.00"
                }
            ],
            "bondEPCTVs": [
                {
                    "paymentS": "0.00",
                    "paymentNS": "0.00",
                    "payment_foodS": "0.00",
                    "payment_foodNS": "0.00"
                }
            ],
            "commissions": [
                {
                    "commission": commission.toFixed(2)
                }
            ],
            "payments_third_party": [
                {
                    "payment_third_party": "0.00"
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "endowment": "0.00",
            "sustaining_support": "0.00",
            "teleworking": "0.00",
            "withdrawal_bonus": "0.00",
            "indemnification": "0.00",
            "refund": "0.00"
        },
        "deductions": {
            "health": {
                "percentage": getNumVal('.healthPercentage', 4).toString(),
                "deduction": healthDeduction.toString()
            },
            "pension_fund": {
                "percentage": getNumVal('.pensionPercentage', 4).toString(),
                "deduction": pensionDeduction.toString()
            },
            "fundSP": {
                "percentage": "0.00",
                "deduction": "0.00",
                "percentageSub": "0.00",
                "deductionSub": "0.00"
            },
            "trade_union": [
                {
                    "percentage": "0.00",
                    "deduction": "0.00"
                }
            ],
            "sanctions": [
                {
                    "sanctionPublic": "0.00",
                    "sanctionPriv": "0.00"
                }
            ],
            "libranzas": [
                {
                    "description": "",
                    "deduction": "0.00"
                }
            ],
            "third_party_payment": [
                {
                    "third_party_pay": thirdPartyPay.toFixed(2)
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "other_deductions": [
                {
                    "other_deduction": otherDeduction.toFixed(2)
                }
            ],
            "voluntary_pension": "0.00",
            "retefuente": "0.00",
            "afc": "0.00",
            "cooperative": "0.00",
            "tax_embargo": "0.00",
            "complementary_plan": "0.00",
            "education": "0.00",
            "refund": "0.00",
            "debt": "0.00"
        },
        "rounding": Math.round(totalVoucher % 100).toString(),
        "total_earned": totalEarned.toString(),
        "deductions_total": totalDeductions.toString(),
        "total_voucher": totalVoucher.toString()
    };
}

// Funci√≥n para actualizar la vista previa
function updatePreview() {
    const jsonData = generateEmployeeJSON();
    const previewElement = document.getElementById('jsonPreview');
    
    if (jsonData && previewElement) {
        previewElement.textContent = JSON.stringify(jsonData, null, 2);
    } else if (previewElement) {
        previewElement.textContent = 'Error: No se pudo generar el JSON. Verifique que todos los campos est√©n completos.';
    }
}

// Funci√≥n para generar y descargar JSON
function generateJSON() {
    const validation = validateRequiredFields();
    
    if (!validation.isValid) {
        alert(`Por favor complete los siguientes campos obligatorios:\n‚Ä¢ ${validation.errors.join('\n‚Ä¢ ')}`);
        return;
    }

    const jsonData = generateEmployeeJSON();
    
    if (!jsonData) {
        alert('Error al generar el JSON. Verifique los datos ingresados.');
        return;
    }

    // Crear archivo y descargarlo
    const jsonString = JSON.stringify(jsonData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `nomina_${jsonData.employee.document_number}_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Archivo JSON descargado exitosamente!');
}

// Funciones para recargar ciudades (si existen en el contexto de API)
function reloadCities() {
    if (typeof convertCityInputToSelect === 'function') {
        convertCityInputToSelect(API_CONFIG?.CITIES_URL || 'https://api-v2.matias-api.com/api/ubl2.1/cities');
    } else {
        console.log('Recargando ciudades...');
    }
}

function reloadWorkCities() {
    const workCitySelect = document.getElementById('workCityId');
    if (workCitySelect && typeof setupCitySelect === 'function') {
        setupCitySelect(workCitySelect, API_CONFIG?.CITIES_URL || 'https://api-v2.matias-api.com/api/ubl2.1/cities');
    } else {
        console.log('Recargando ciudades de trabajo...');
    }
}

// Configuraci√≥n de c√°lculos autom√°ticos
function setupCalculations(employeeDiv) {
    const salaryInput = employeeDiv.querySelector('.salary');
    const workedDaysInput = employeeDiv.querySelector('.workedDays');
    const salaryWorkedInput = employeeDiv.querySelector('.salaryWorked');
    const healthPercentageInput = employeeDiv.querySelector('.healthPercentage');
    const healthDeductionInput = employeeDiv.querySelector('.healthDeduction');
    const pensionPercentageInput = employeeDiv.querySelector('.pensionPercentage');
    const pensionDeductionInput = employeeDiv.querySelector('.pensionDeduction');
    
    // Campos para todos los tipos de horas extras
    const hedAmountInput = employeeDiv.querySelector('.hedAmount');
    const hedPercentageInput = employeeDiv.querySelector('.hedPercentage');
    const hedPaymentInput = employeeDiv.querySelector('.hedPayment');
    
    const henAmountInput = employeeDiv.querySelector('.henAmount');
    const henPercentageInput = employeeDiv.querySelector('.henPercentage');
    const henPaymentInput = employeeDiv.querySelector('.henPayment');
    
    const hedfAmountInput = employeeDiv.querySelector('.hedfAmount');
    const hedfPercentageInput = employeeDiv.querySelector('.hedfPercentage');
    const hedfPaymentInput = employeeDiv.querySelector('.hedfPayment');
    
    const hrnAmountInput = employeeDiv.querySelector('.hrnAmount');
    const hrnPercentageInput = employeeDiv.querySelector('.hrnPercentage');
    const hrnPaymentInput = employeeDiv.querySelector('.hrnPayment');
    
    const hrdfAmountInput = employeeDiv.querySelector('.hrdfAmount');
    const hrdfPercentageInput = employeeDiv.querySelector('.hrdfPercentage');
    const hrdfPaymentInput = employeeDiv.querySelector('.hrdfPayment');
    
    const hendfAmountInput = employeeDiv.querySelector('.hendfAmount');
    const hendfPercentageInput = employeeDiv.querySelector('.hendfPercentage');
    const hendfPaymentInput = employeeDiv.querySelector('.hendfPayment');
    
    const hrndfAmountInput = employeeDiv.querySelector('.hrndfAmount');
    const hrndfPercentageInput = employeeDiv.querySelector('.hrndfPercentage');
    const hrndfPaymentInput = employeeDiv.querySelector('.hrndfPayment');

    function calculateAll() {
        const salary = parseFloat(salaryInput?.value) || 0;
        const workedDays = parseFloat(workedDaysInput?.value) || 30;
        const healthPercentage = parseFloat(healthPercentageInput?.value) || 4;
        const pensionPercentage = parseFloat(pensionPercentageInput?.value) || 4;
        
        // Calcular salario trabajado
        const salaryWorked = salary > 0 ? Math.round((salary / 30) * workedDays) : 0;
        if (salaryWorkedInput) salaryWorkedInput.value = salaryWorked;
        
        // Valor hora base (220 horas mensuales = 30 d√≠as x 8 horas)
        const valorHora = salary > 0 ? salary / 220 : 0;
        
        // Calcular todas las horas extras
        const calculations = [
            { amount: hedAmountInput, percentage: hedPercentageInput, payment: hedPaymentInput, defaultPercent: 25, type: 'extra' },
            { amount: henAmountInput, percentage: henPercentageInput, payment: henPaymentInput, defaultPercent: 75, type: 'extra' },
            { amount: hedfAmountInput, percentage: hedfPercentageInput, payment: hedfPaymentInput, defaultPercent: 105, type: 'extra' },
            { amount: hrnAmountInput, percentage: hrnPercentageInput, payment: hrnPaymentInput, defaultPercent: 35, type: 'recargo' },
            { amount: hrdfAmountInput, percentage: hrdfPercentageInput, payment: hrdfPaymentInput, defaultPercent: 80, type: 'recargo' },
            { amount: hendfAmountInput, percentage: hendfPercentageInput, payment: hendfPaymentInput, defaultPercent: 155, type: 'extra' },
            { amount: hrndfAmountInput, percentage: hrndfPercentageInput, payment: hrndfPaymentInput, defaultPercent: 115, type: 'recargo' }
        ];

        calculations.forEach(calc => {
            const amount = parseFloat(calc.amount?.value) || 0;
            const percentage = parseFloat(calc.percentage?.value) || calc.defaultPercent;
            let payment = 0;
            
            if (amount > 0 && valorHora > 0) {
                if (calc.type === 'extra') {
                    payment = Math.round(valorHora * (1 + percentage / 100) * amount);
                } else { // recargo
                    payment = Math.round(valorHora * (percentage / 100) * amount);
                }
            }
            
            if (calc.payment) calc.payment.value = payment;
        });
        
        // Calcular deducciones sobre salario trabajado
        const healthDeduction = Math.round(salaryWorked * healthPercentage / 100);
        const pensionDeduction = Math.round(salaryWorked * pensionPercentage / 100);
        
        if (healthDeductionInput) healthDeductionInput.value = healthDeduction;
        if (pensionDeductionInput) pensionDeductionInput.value = pensionDeduction;
        
        // Actualizar resumen despu√©s de calcular
        setTimeout(updatePaymentSummary, 100);
    }

    // Eventos para recalcular autom√°ticamente
    const allInputs = [
        salaryInput, workedDaysInput, healthPercentageInput, pensionPercentageInput,
        hedAmountInput, hedPercentageInput, henAmountInput, henPercentageInput,
        hedfAmountInput, hedfPercentageInput, hrnAmountInput, hrnPercentageInput,
        hrdfAmountInput, hrdfPercentageInput, hendfAmountInput, hendfPercentageInput,
        hrndfAmountInput, hrndfPercentageInput
    ];

    allInputs.forEach(input => {
        if (input) {
            input.addEventListener('input', calculateAll);
        }
    });

    // Calcular inicialmente
    calculateAll();
}

// Funci√≥n para convertir input de ciudad de trabajo a select con datos de la API
async function convertWorkCityInputToSelect(apiUrl) {
    const workCityInput = document.getElementById('workCityId');
    if (!workCityInput) return;
    // Crear nuevo select
    const workCitySelect = document.createElement('select');
    workCitySelect.id = 'workCityId';
    workCitySelect.className = workCityInput.className;
    workCitySelect.style.cssText = workCityInput.style.cssText;
    // Mantener el valor actual como opci√≥n por defecto
    const currentValue = workCityInput.value;
    // Cargar ciudades desde la API
    const cities = await loadCitiesFromAPI(apiUrl);
    
    if (cities.length > 0) {
        populateCitySelect(cities, workCitySelect);
        // Si hab√≠a un valor previo, intentar seleccionarlo
        if (currentValue) {
            const matchingOption = Array.from(workCitySelect.options).find(
                option => option.value === currentValue
            );
            if (matchingOption) {
                workCitySelect.value = currentValue;
            }
        }
        // Reemplazar input por select
        workCityInput.parentNode.replaceChild(workCitySelect, workCityInput);
        
        console.log('‚úÖ Campo de ciudad de trabajo convertido a select con datos de la API');
    } else {
        console.warn('‚ö†Ô∏è No se pudieron cargar ciudades de la API para ciudad de trabajo, manteniendo input original');
    }
}

// Funci√≥n para recargar ciudades de trabajo manualmente
async function reloadWorkCities() {
    const API_URL = 'https://api-v2.matias-api.com/api/ubl2.1/cities';
    try {
        const workCityElement = document.getElementById('workCityId');
        const currentValue = workCityElement.value;
        const reloadBtn = workCityElement.parentNode.querySelector('.btn-reload');
        if (reloadBtn) {
            reloadBtn.innerHTML = '‚è≥';
            reloadBtn.disabled = true;
        }
        if (workCityElement.tagName.toLowerCase() === 'select') {
            const tempInput = document.createElement('input');
            tempInput.type = 'text';
            tempInput.id = 'workCityId';
            tempInput.className = workCityElement.className;
            tempInput.style.cssText = workCityElement.style.cssText;
            tempInput.value = currentValue;
            tempInput.placeholder = 'Medell√≠n';
            workCityElement.parentNode.replaceChild(tempInput, workCityElement);
        }
        await convertWorkCityInputToSelect(API_URL);
        if (reloadBtn) {
            reloadBtn.innerHTML = 'üîÑ';
            reloadBtn.disabled = false;
        }
        alert('‚úÖ Ciudades de trabajo recargadas exitosamente desde la API');
    } catch (error) {
        console.error('Error recargando ciudades de trabajo:', error);
        alert('‚ùå Error al recargar las ciudades de trabajo. Verifique la conexi√≥n.');
        const reloadBtn = document.querySelector('#workCityId ~ .btn-reload');
        if (reloadBtn) {
            reloadBtn.innerHTML = 'üîÑ';
            reloadBtn.disabled = false;
        }
    }
}

// Funci√≥n opcional para manejar ciudades de trabajo en empleados
async function setupWorkCitiesForEmployees(apiUrl = 'https://api-v2.matias-api.com/api/ubl2.1/cities') {
    // Esta funci√≥n se puede llamar cuando se agreguen nuevos empleados
    const workCityInputs = document.querySelectorAll('.workCityId');
    
    for (const input of workCityInputs) {
        if (input.tagName.toLowerCase() === 'input') {
            const select = document.createElement('select');
            select.className = input.className;
            select.style.cssText = input.style.cssText;
            
            const currentValue = input.value;
            const cities = await loadCitiesFromAPI(apiUrl);
            
            if (cities.length > 0) {
                populateCitySelect(cities, select);
                if (currentValue) {
                    select.value = currentValue;
                }
                input.parentNode.replaceChild(select, input);
            }
        }
    }
}

// Funci√≥n para recargar ciudades manualmente
async function reloadCities() {
    const API_URL = 'https://api-v2.matias-api.com/api/ubl2.1/cities';
    
    try {
        const cityElement = document.getElementById('generationCityId');
        const currentValue = cityElement.value;
        
        // Mostrar indicador de carga
        const reloadBtn = document.querySelector('.btn-reload');
        if (reloadBtn) {
            reloadBtn.innerHTML = '‚è≥';
            reloadBtn.disabled = true;
        }
        
        // Si es un select, convertir a input temporalmente
        if (cityElement.tagName.toLowerCase() === 'select') {
            const tempInput = document.createElement('input');
            tempInput.type = 'text';
            tempInput.id = 'generationCityId';
            tempInput.className = cityElement.className;
            tempInput.style.cssText = cityElement.style.cssText;
            tempInput.value = currentValue;
            tempInput.placeholder = '836';
            
            cityElement.parentNode.replaceChild(tempInput, cityElement);
        }
        
        // Cargar ciudades nuevamente
        await convertCityInputToSelect(API_URL);
        
        // Restaurar bot√≥n
        if (reloadBtn) {
            reloadBtn.innerHTML = 'üîÑ';
            reloadBtn.disabled = false;
        }
        
        alert('‚úÖ Ciudades recargadas exitosamente desde la API');
        
    } catch (error) {
        console.error('Error recargando ciudades:', error);
        alert('‚ùå Error al recargar las ciudades. Verifique la conexi√≥n.');
        
        // Restaurar bot√≥n en caso de error
        const reloadBtn = document.querySelector('.btn-reload');
        if (reloadBtn) {
            reloadBtn.innerHTML = 'üîÑ';
            reloadBtn.disabled = false;
        }
    }
}

// Funci√≥n para actualizar tiempo trabajado seg√∫n el per√≠odo
function updateTimeWorkedByPeriod() {
    const periodSelect = document.getElementById('periodId');
    const timeWorkedInput = document.getElementById('timeWorked');
    const workedDaysInputs = document.querySelectorAll('.workedDays');
    
    if (!periodSelect || !timeWorkedInput) return;
    
    const periodValue = periodSelect.value;
    let defaultDays = 30; // Valor por defecto
    
    switch(periodValue) {
        case '1': // Diario
            defaultDays = 1;
            break;
        case '2': // Semanal
            defaultDays = 7;
            break;
        case '3': // Decenal
            defaultDays = 10;
            break;
        case '4': // Quincenal
            defaultDays = 15;
            break;
        case '5': // Mensual
            defaultDays = 30;
            break;
        case '6': // Otro (acuerdo especial)
            defaultDays = 30; // Mantener el valor actual o usar 30 por defecto
            break;
    }
    
    // Actualizar el campo "Tiempo Trabajado"
    timeWorkedInput.value = defaultDays;
    
    // Tambi√©n actualizar todos los campos "D√≠as Trabajados" de empleados
    workedDaysInputs.forEach(input => {
        input.value = defaultDays;
        // Disparar evento para recalcular salarios
        input.dispatchEvent(new Event('input'));
    });
}

// Evento para detectar cambios en el per√≠odo
document.addEventListener('DOMContentLoaded', function() {
    const periodSelect = document.getElementById('periodId');
    
    if (periodSelect) {
        // Configurar el valor inicial
        updateTimeWorkedByPeriod();
        
        // Escuchar cambios en el select de per√≠odo
        periodSelect.addEventListener('change', updateTimeWorkedByPeriod);
    }
    
    // Inicializar ciudades desde la API
    initializeCities();

    // Inicializar c√°lculos autom√°ticos para el √∫nico empleado
    const unicoEmpleado = document.querySelector('.employee-section');
    if (unicoEmpleado) {
        setupCalculations(unicoEmpleado);
    }
});

// Funci√≥n para inicializar las ciudades
async function initializeCities() {
    const API_URL = 'https://api-v2.matias-api.com/api/ubl2.1/cities';
    try {
        // Ciudad de Generaci√≥n
        await convertCityInputToSelect(API_URL);
        // Ciudad de Trabajo
        await convertWorkCityInputToSelect(API_URL);
    } catch (error) {
        console.error('Error inicializando ciudades:', error);
    }
}

// Auto-actualizar vista previa cuando cambian los datos
document.addEventListener('input', function(e) {
    if (e.target.matches('input, select')) {
        setTimeout(updatePreview, 500);
    }
});

// Inicializar fechas con valores por defecto
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];
    
    document.getElementById('payDay').value = today;
    document.getElementById('generationDate').value = today;
    document.getElementById('dateEntry').value = '2017-01-01';
    document.getElementById('settlementStartDate').value = firstDay;
    document.getElementById('settlementEndDate').value = lastDay;
    
    // Inicializar ciudades desde la API
    initializeCities();

    // Inicializar c√°lculos autom√°ticos para el √∫nico empleado
    const unicoEmpleado = document.querySelector('.employee-section');
    if (unicoEmpleado) {
        setupCalculations(unicoEmpleado);
    }
});

// Funci√≥n para actualizar resumen
document.addEventListener('input', function(e) {
    if (e.target.matches('input[type="number"], input[type="text"]')) {
        setTimeout(updatePaymentSummary, 100);
    }
});

// Inicializar resumen al cargar
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updatePaymentSummary, 500);
});

// Funci√≥n para manejar cambios en el medio de pago
function handlePaymentMethodChange() {
    const meansPaymentSelect = document.querySelector('.meansPaymentId');
    const bankInput = document.querySelector('.bank');
    const accountNumberInput = document.querySelector('.accountNumber');
    const accountTypeSelect = document.querySelector('.accountType');
    const bankRequired = document.querySelector('.bank-required');
    const accountRequired = document.querySelector('.account-required');
    
    if (!meansPaymentSelect) return;
    
    const selectedValue = meansPaymentSelect.value;
    
    if (selectedValue === '10') { // Efectivo
        if (bankInput) {
            bankInput.value = 'NO APLICA';
            bankInput.readOnly = true;
            bankInput.removeAttribute('required');
            bankInput.style.backgroundColor = '#f5f5f5';
        }
        
        if (accountNumberInput) {
            accountNumberInput.value = '00000';
            accountNumberInput.readOnly = true;
            accountNumberInput.removeAttribute('required');
            accountNumberInput.style.backgroundColor = '#f5f5f5';
        }
        
        if (accountTypeSelect) {
            accountTypeSelect.value = 'AHORROS';
            accountTypeSelect.disabled = true;
            accountTypeSelect.style.backgroundColor = '#f5f5f5';
        }
        
        if (bankRequired) bankRequired.style.display = 'none';
        if (accountRequired) accountRequired.style.display = 'none';
        
    } else { // D√©bito bancario
        if (bankInput) {
            bankInput.value = '';
            bankInput.readOnly = false;
            bankInput.setAttribute('required', '');
            bankInput.style.backgroundColor = '';
            bankInput.placeholder = 'Bancolombia';
        }
        
        if (accountNumberInput) {
            accountNumberInput.value = '';
            accountNumberInput.readOnly = false;
            accountNumberInput.setAttribute('required', '');
            accountNumberInput.style.backgroundColor = '';
            accountNumberInput.placeholder = '123456789';
        }
        
        if (accountTypeSelect) {
            accountTypeSelect.disabled = false;
            accountTypeSelect.style.backgroundColor = '';
        }
        
        if (bankRequired) bankRequired.style.display = 'inline';
        if (accountRequired) accountRequired.style.display = 'inline';
    }
}

// Evento para detectar cambios en el medio de pago
document.addEventListener('DOMContentLoaded', function() {
    // Configurar evento para medio de pago
    const meansPaymentSelect = document.querySelector('.meansPaymentId');
    if (meansPaymentSelect) {
        meansPaymentSelect.addEventListener('change', handlePaymentMethodChange);
        
        // Aplicar configuraci√≥n inicial
        handlePaymentMethodChange();
    }
});

// Funci√≥n para actualizar el resumen de pagos
function updatePaymentSummary() {
    const employeeDiv = document.querySelector('.employee-section');
    if (!employeeDiv) return;

    const getNumVal = (selector) => {
        const element = employeeDiv.querySelector(selector);
        return parseFloat(element?.value) || 0;
    };

    // Devengados
    const salaryWorked = getNumVal('.salaryWorked');
    
    // Todas las horas extras
    const hedPayment = getNumVal('.hedPayment');
    const henPayment = getNumVal('.henPayment');
    const hedfPayment = getNumVal('.hedfPayment');
    const hrnPayment = getNumVal('.hrnPayment');
    const hrdfPayment = getNumVal('.hrdfPayment');
    const hendfPayment = getNumVal('.hendfPayment');
    const hrndfPayment = getNumVal('.hrndfPayment');
    
    const totalOvertime = hedPayment + henPayment + hedfPayment + hrnPayment + hrdfPayment + hendfPayment + hrndfPayment;
    
    const transportationAssistance = getNumVal('.transportationAssistance');
    const bonusPayment = getNumVal('.bonusPayment');
    const primePayment = getNumVal('.primePayment');
    const commission = getNumVal('.commission');
    const conceptS = getNumVal('.conceptS');
    const otherConcepts = bonusPayment + primePayment + commission + conceptS;
    const totalEarned = salaryWorked + totalOvertime + transportationAssistance + otherConcepts;

    // Deducciones
    const healthDeduction = getNumVal('.healthDeduction');
    const pensionDeduction = getNumVal('.pensionDeduction');
    const thirdPartyPay = getNumVal('.thirdPartyPay');
    const otherDeduction = getNumVal('.otherDeduction');
    const otherDeductions = thirdPartyPay + otherDeduction;
    const totalDeductions = healthDeduction + pensionDeduction + otherDeductions;

    // Neto a pagar
    const netPay = totalEarned - totalDeductions;

    // Actualizar resumen
    const formatCurrency = (value) => new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
    }).format(value);

    // Actualizar elementos si existen
    const summaryElements = {
        '.summary-salaryWorked': salaryWorked,
        '.summary-overtime': totalOvertime,
        '.summary-transport': transportationAssistance,
        '.summary-others': otherConcepts,
        '.summary-totalEarned': totalEarned,
        '.summary-health': healthDeduction,
        '.summary-pension': pensionDeduction,
        '.summary-otherDeductions': otherDeductions,
        '.summary-totalDeductions': totalDeductions,
        '.summary-netPay': netPay
    };

    Object.entries(summaryElements).forEach(([selector, value]) => {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = formatCurrency(value);
        }
    });
}

// Funci√≥n para validar campos obligatorios
function validateRequiredFields() {
    const meansPaymentSelect = document.querySelector('.meansPaymentId');
    const isEffectivo = meansPaymentSelect?.value === '10';
    
    let requiredSelectors = [
        '.documentNumber',
        '.firstName', 
        '.firstSurname',
        '.salary',
        '.workerCode',
        '.workAddress'
    ];
    
    if (!isEffectivo) {
        requiredSelectors.push('.bank', '.accountNumber');
    }

    let isValid = true;
    const errors = [];

    requiredSelectors.forEach(selector => {
        const field = document.querySelector(selector);
        const formGroup = field?.closest('.form-group');
        
        if (field && formGroup) {
            formGroup.classList.remove('has-error');
            const existingError = formGroup.querySelector('.error-message');
            if (existingError) existingError.remove();

            if (!field.readOnly && !field.value.trim()) {
                isValid = false;
                const fieldName = field.closest('.form-group').querySelector('label').textContent.replace('*', '').trim();
                errors.push(fieldName);
                
                formGroup.classList.add('has-error');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'Este campo es obligatorio';
                field.parentNode.appendChild(errorMsg);
            }
        }
    });

    return { isValid, errors };
}

// Funci√≥n principal para generar el JSON del empleado
function generateEmployeeJSON() {
    const employeeDiv = document.querySelector('.employee-section');
    if (!employeeDiv) return null;

    const getVal = (selector, defaultVal = '') => {
        const element = employeeDiv.querySelector(selector);
        return element ? element.value.trim() : defaultVal;
    };
    
    const getNumVal = (selector, defaultVal = 0) => {
        const val = parseFloat(getVal(selector));
        return isNaN(val) ? defaultVal : val;
    };

    const getCurrentTime = () => {
        const now = new Date();
        return now.toTimeString().split(' ')[0];
    };

    const timeNow = getCurrentTime();
    
    // Datos b√°sicos
    const salary = getNumVal('.salary');
    const workedDays = getNumVal('.workedDays', 30);
    
    // Todas las horas extras
    const hedAmount = getNumVal('.hedAmount');
    const hedPercentage = getNumVal('.hedPercentage', 25);
    const hedPayment = getNumVal('.hedPayment');
    
    const henAmount = getNumVal('.henAmount');
    const henPercentage = getNumVal('.henPercentage', 75);
    const henPayment = getNumVal('.henPayment');
    
    const hedfAmount = getNumVal('.hedfAmount');
    const hedfPercentage = getNumVal('.hedfPercentage', 100);
    const hedfPayment = getNumVal('.hedfPayment');
    
    const hrnAmount = getNumVal('.hrnAmount');
    const hrnPercentage = getNumVal('.hrnPercentage', 35);
    const hrnPayment = getNumVal('.hrnPayment');
    
    const hrdfAmount = getNumVal('.hrdfAmount');
    const hrdfPercentage = getNumVal('.hrdfPercentage', 75);
    const hrdfPayment = getNumVal('.hrdfPayment');
    
    const hendfAmount = getNumVal('.hendfAmount');
    const hendfPercentage = getNumVal('.hendfPercentage', 150);
    const hendfPayment = getNumVal('.hendfPayment');
    
    const hrndfAmount = getNumVal('.hrndfAmount');
    const hrndfPercentage = getNumVal('.hrndfPercentage', 110);
    const hrndfPayment = getNumVal('.hrndfPayment');
    
    // Otros conceptos
    const transportationAssistance = getNumVal('.transportationAssistance');
    const bonusPayment = getNumVal('.bonusPayment');
    const primePayment = getNumVal('.primePayment');
    const commission = getNumVal('.commission');
    const conceptS = getNumVal('.conceptS');
    
    // Calcular totales
    const totalOvertimePayment = hedPayment + henPayment + hedfPayment + hrnPayment + hrdfPayment + hendfPayment + hrndfPayment;
    const salaryWorked = getNumVal('.salaryWorked');
    const totalEarned = salaryWorked + transportationAssistance + totalOvertimePayment + bonusPayment + primePayment + commission + conceptS;
    
    // Deducciones
    const healthDeduction = getNumVal('.healthDeduction');
    const pensionDeduction = getNumVal('.pensionDeduction');
    const thirdPartyPay = getNumVal('.thirdPartyPay');
    const otherDeduction = getNumVal('.otherDeduction');
    
    const totalDeductions = healthDeduction + pensionDeduction + thirdPartyPay + otherDeduction;
    const totalVoucher = totalEarned - totalDeductions;

    return {
        "resolution_number": document.getElementById('resolutionNumber')?.value || "18760000001",
        "document_number": document.getElementById('documentNumber')?.value || "27",
        "generation_city_id": document.getElementById('generationCityId')?.value || "1",
        "worker_code": getVal('.workerCode'),
        "novelty": false,
        "pay_day": document.getElementById('payDay')?.value || new Date().toISOString().split('T')[0],
        "period": {
            "date_entry": document.getElementById('dateEntry')?.value || "",
            "departure_date": document.getElementById('departureDate')?.value || null,
            "settlement_start_date": document.getElementById('settlementStartDate')?.value || new Date().toISOString().split('T')[0],
            "settlement_end_date": document.getElementById('settlementEndDate')?.value || new Date().toISOString().split('T')[0],
            "time_worked": document.getElementById('timeWorked')?.value || "30",
            "generation_date": document.getElementById('generationDate')?.value || new Date().toISOString().split('T')[0]
        },
        "general_information": {
            "generation_date": document.getElementById('generationDate')?.value || new Date().toISOString().split('T')[0],
            "generation_time": timeNow,
            "period_id": document.getElementById('periodId')?.value || "5",
            "currency_id": "272",
            "trm": "0"
        },
        "notes": "",
        "employee": {
            "worker_type_id": parseInt(getVal('.workerTypeId', '1')),
            "worker_subtype_id": parseInt(getVal('.workerSubtypeId', '1')),
            "high_risk_pension": getVal('.highRiskPension', 'false'),
            "identity_document_id": getVal('.identityDocumentId', '1'),
            "document_number": getVal('.documentNumber'),
            "first_surname": getVal('.firstSurname'),
            "second_surname": getVal('.secondSurname'),
            "first_name": getVal('.firstName'),
            "other_names": getVal('.otherNames'),
            "working_country_id": getNumVal('.workingCountryId', 45),
            "work_city_id": getNumVal('.workCityId'),
            "work_address": getVal('.workAddress'),
            "integral_salary": getVal('.integralSalary', 'false'),
            "contract_type_id": parseInt(getVal('.contractTypeId', '1')),
            "salary": salary.toString(),
            "worker_code": getVal('.workerCode')
        },
        "payment": {
            "payment_method_id": getVal('.paymentMethodId', '1'),
            "means_payment_id": getVal('.meansPaymentId', '31'),
            "bank": getVal('.bank'),
            "account_type": getVal('.accountType'),
            "account_number": getVal('.accountNumber')
        },
        "earn": {
            "basic": {
                "worked_days": workedDays.toString(),
                "salary_worked": salaryWorked.toString()
            },
            "transport": {
                "transportation_assistance": transportationAssistance.toString(),
                "viatic_maintenance": getNumVal('.viaticMaintenance').toString(),
                "viatic_non_salary_maintenance": getNumVal('.viaticNonSalary').toString()
            },
            "HEDs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedAmount.toString(),
                    "percentage": hedPercentage.toFixed(2),
                    "payment": hedPayment.toFixed(2)
                }
            ],
            "HENs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": henAmount.toString(),
                    "percentage": henPercentage.toFixed(2),
                    "payment": henPayment.toFixed(2)
                }
            ],
            "HRNs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrnAmount.toString(),
                    "percentage": hrnPercentage.toFixed(2),
                    "payment": hrnPayment.toFixed(2)
                }
            ],
            "HEDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hedfAmount.toString(),
                    "percentage": hedfPercentage.toFixed(2),
                    "payment": hedfPayment.toFixed(2)
                }
            ],
            "HRDDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrdfAmount.toString(),
                    "percentage": hrdfPercentage.toFixed(2),
                    "payment": hrdfPayment.toFixed(2)
                }
            ],
            "HENDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hendfAmount.toString(),
                    "percentage": hendfPercentage.toFixed(2),
                    "payment": hendfPayment.toFixed(2)
                }
            ],
            "HRNDFs": [
                {
                    "start_time": "2021-12-31T00:00:00",
                    "final_hour": "2021-12-31T00:00:00",
                    "amount": hrndfAmount.toString(),
                    "percentage": hrndfPercentage.toFixed(2),
                    "payment": hrndfPayment.toFixed(2)
                }
            ],
            "vacations": {
                "common": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "paid": {
                    "amount": "0",
                    "payment": "0.00"
                }
            },
            "bonus": {
                "amount": "0",
                "payment": bonusPayment.toFixed(2),
                "non_salary_payment": primePayment.toFixed(2)
            },
            "cesantias": {
                "payment": "0",
                "percentage": "0.00",
                "interest_payment": "0.00"
            },
            "incapacity": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "type_id": 1,
                    "payment": "0.00"
                }
            ],
            "licenses": {
                "licenseMP": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0",
                    "payment": "0.00"
                },
                "licenseNR": {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            },
            "bonuses": [
                {
                    "bonusS": bonusPayment.toFixed(2),
                    "bonusNS": primePayment.toFixed(2)
                }
            ],
            "assistances": [
                {
                    "assistanceS": "0.00",
                    "assistanceNS": "0.00"
                }
            ],
            "legal_strikes": [
                {
                    "start_date": "2021-12-31",
                    "final_date": "2021-12-31",
                    "amount": "0"
                }
            ],
            "other_concepts": [
                {
                    "description": "Otros conceptos",
                    "conceptS": conceptS.toFixed(2),
                    "conceptNS": "0.00"
                }
            ],
            "compensations": [
                {
                    "compensationO": "0.00",
                    "compensationE": "0.00"
                }
            ],
            "bondEPCTVs": [
                {
                    "paymentS": "0.00",
                    "paymentNS": "0.00",
                    "payment_foodS": "0.00",
                    "payment_foodNS": "0.00"
                }
            ],
            "commissions": [
                {
                    "commission": commission.toFixed(2)
                }
            ],
            "payments_third_party": [
                {
                    "payment_third_party": "0.00"
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "endowment": "0.00",
            "sustaining_support": "0.00",
            "teleworking": "0.00",
            "withdrawal_bonus": "0.00",
            "indemnification": "0.00",
            "refund": "0.00"
        },
        "deductions": {
            "health": {
                "percentage": getNumVal('.healthPercentage', 4).toString(),
                "deduction": healthDeduction.toString()
            },
            "pension_fund": {
                "percentage": getNumVal('.pensionPercentage', 4).toString(),
                "deduction": pensionDeduction.toString()
            },
            "fundSP": {
                "percentage": "0.00",
                "deduction": "0.00",
                "percentageSub": "0.00",
                "deductionSub": "0.00"
            },
            "trade_union": [
                {
                    "percentage": "0.00",
                    "deduction": "0.00"
                }
            ],
            "sanctions": [
                {
                    "sanctionPublic": "0.00",
                    "sanctionPriv": "0.00"
                }
            ],
            "libranzas": [
                {
                    "description": "",
                    "deduction": "0.00"
                }
            ],
            "third_party_payment": [
                {
                    "third_party_pay": thirdPartyPay.toFixed(2)
                }
            ],
            "advances": [
                {
                    "advance": "0.00"
                }
            ],
            "other_deductions": [
                {
                    "other_deduction": otherDeduction.toFixed(2)
                }
            ],
            "voluntary_pension": "0.00",
            "retefuente": "0.00",
            "afc": "0.00",
            "cooperative": "0.00",
            "tax_embargo": "0.00",
            "complementary_plan": "0.00",
            "education": "0.00",
            "refund": "0.00",
            "debt": "0.00"
        },
        "rounding": Math.round(totalVoucher % 100).toString(),
        "total_earned": totalEarned.toString(),
        "deductions_total": totalDeductions.toString(),
        "total_voucher": totalVoucher.toString()
    };
}

// Funci√≥n para actualizar resumen
document.addEventListener('input', function(e) {
    if (e.target.matches('input[type="number"], input[type="text"]')) {
        setTimeout(updatePaymentSummary, 100);
    }
});

// Inicializar resumen al cargar
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updatePaymentSummary, 500);
});



